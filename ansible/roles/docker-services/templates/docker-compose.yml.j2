services:
  # === MISCELLANEOUS ===
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "8222:80"
    volumes:
      - {{ media_dirs.config }}/vaultwarden:/data
    environment:
      DOMAIN: "https://vault.{{ domain_name }}"
      SIGNUPS_ALLOWED: "false"
      TZ: ${TZ}
      ADMIN_TOKEN: ${ADMIN_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # === MEDIA SERVERS ===
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    privileged: true
    networks:
      - reverse-proxy
    ports:
      - "8096:8096"
      - "7359:7359"
    volumes:
      - {{ media_dirs.config }}/jellyfin:/config:rw
      - {{ media_dirs.transcodes }}:/transcodes:rw
      - {{ media_dirs.media }}/anime:/media/anime:ro
      - {{ media_dirs.media }}/movies:/media/movies:ro
      - {{ media_dirs.media }}/tv:/media/tv:ro
      - /dev/dri:/dev/dri:rw
    environment:
      JELLYFIN_PublishedServerUrl: ${JELLYFIN_PublishedServerUrl}
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  streamystats:
    image: docker.io/fredrikburmester/streamystats-v2-aio:latest
    container_name: streamystats
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "3000:3000"
    volumes:
      - {{ media_dirs.config }}/streamystats/postgres:/var/lib/postgresql/data:rw
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}
      SESSION_SECRET: ${SESSION_SECRET}
      NODE_ENV: production
      TZ: ${TZ}
      SESSION_POLL_INTERVAL_MS: "5000"
      CRON_ACTIVITY_SYNC: "*/1 * * * *"
      CRON_RECENT_ITEMS_SYNC: "*/1 * * * *"
      CRON_USER_SYNC: "*/1 * * * *"
      CRON_PEOPLE_SYNC: "*/15 * * * *"
      CRON_EMBEDDINGS_SYNC: "*/15 * * * *"
      CRON_GEOLOCATION_SYNC: "*/5 * * * *"
      CRON_FINGERPRINT_SYNC: "0 4 * * *"
      CRON_JOB_CLEANUP: "*/1 * * * *"
      CRON_OLD_JOB_CLEANUP: "0 3 * * *"
      CRON_FULL_SYNC: "0 2 * * *"
      CRON_DELETED_ITEMS_CLEANUP: "0 * * * *"
      SKIP_STARTUP_FULL_SYNC: "false"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "5055:5055"
    volumes:
      - {{ media_dirs.config }}/jellyseerr:/app/config:rw
    environment:
      TZ: ${TZ}
      LOG_LEVEL: info
      PORT: "5055"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # === MEDIA MANAGEMENT (ARR STACK) ===
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "7878:7878"
    volumes:
      - {{ media_dirs.config }}/radarr:/config:rw
      - {{ media_dirs.media }}/movies:/movies:rw
      - {{ media_dirs.torrents }}:/downloads:rw
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "8989:8989"
    volumes:
      - {{ media_dirs.config }}/sonarr:/config:rw
      - {{ media_dirs.media }}/tv:/tv:rw
      - {{ media_dirs.media }}/anime:/anime:rw
      - {{ media_dirs.torrents }}:/downloads:rw
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "9696:9696"
    volumes:
      - {{ media_dirs.config }}/prowlarr:/config:rw
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  profilarr:
    image: santiagosayshey/profilarr:latest
    container_name: profilarr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "6868:6868"
    volumes:
      - {{ media_dirs.config }}/profilarr:/config:rw
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}

  # === DOWNLOAD CLIENTS ===
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    ports:
      - "8000:8000"   # Gluetun control
      - "8080:8080"   # qBittorrent WebUI
      - "6881:6881"   # Torrent port
      - "6881:6881/udp"
    volumes:
      - {{ media_dirs.config }}/gluetun:/gluetun:rw
    environment:
      VPN_SERVICE_PROVIDER: ${VPN_SERVICE_PROVIDER}
      VPN_TYPE: ${VPN_TYPE}
      WIREGUARD_PRIVATE_KEY: ${WIREGUARD_PRIVATE_KEY}
      SERVER_COUNTRIES: ${SERVER_COUNTRIES}
      TZ: ${TZ}

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    volumes:
      - {{ media_dirs.config }}/qbittorrent:/config:rw
      - {{ media_dirs.torrents }}:/downloads:rw
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      WEBUI_PORT: "8080"
      TORRENTING_PORT: "6881"

  qui:
    image: ghcr.io/autobrr/qui:latest
    container_name: qui
    restart: unless-stopped
    networks:
      - reverse-proxy
    ports:
      - "7476:7476"
    volumes:
      - {{ media_dirs.config }}/qui:/config

  flaresolverr:
    image: flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - reverse-proxy
    ports:
      - "8191:8191"
    environment:
      LOG_LEVEL: info
      TZ: ${TZ}
    healthcheck:
      test: ["CMD", "curl", "-f", "-X", "POST", "-H", "Content-Type: application/json", "-d", "{\"cmd\":\"request.get\",\"url\":\"http://www.google.com/\",\"maxTimeout\":60000}", "http://localhost:8191/v1"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    privileged: true
    ports:
      - "8085:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - reverse-proxy

networks:
  reverse-proxy:
    driver: bridge
