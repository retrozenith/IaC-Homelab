services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Dashboard
      - "8082:8082" # Metrics
    environment:
      - CF_DNS_API_TOKEN={{ cloudflare_api_token | default('') }}
      - CF_ZONE_API_TOKEN={{ cloudflare_api_token | default('') }}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - /opt/traefik/config:/etc/traefik/config:ro
      - /opt/traefik/acme.json:/etc/traefik/acme.json
      - /var/log/traefik:/var/log/traefik
    networks:
      - reverse-proxy

  cloudflare-ddns:
    image: favonia/cloudflare-ddns:latest
    container_name: cloudflare-ddns
    restart: unless-stopped
    network_mode: host
    environment:
      - CF_API_TOKEN={{ cloudflare_api_token | default('') }}
      - DOMAINS={{ domain_name }},*.{{ domain_name }}
      - PROXIED=true
      - IP6_PROVIDER=none
      - PUID=1000
      - PGID=1000

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - CF_API_TOKEN={{ cloudflare_api_token | default('') }}
      - F2B_LOG_TARGET=STDOUT
      - F2B_LOG_LEVEL=INFO
      - F2B_DB_PURGE_AGE=1d
    volumes:
      - /opt/traefik/fail2ban:/data
      - /var/log/traefik:/var/log/traefik:ro

networks:
  reverse-proxy:
    external: true
