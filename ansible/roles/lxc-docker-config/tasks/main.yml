---
# This role configures the media stack LXC for Docker and optional GPU support
# Runs on the Proxmox host to enable privileged mode and features

- name: Stop media stack LXC
  ansible.builtin.command:
    cmd: "pct stop {{ media_lxc_id }}"
  delegate_to: "{{ proxmox_host }}"
  register: stop_media_lxc
  failed_when: stop_media_lxc.rc != 0 and "is not running" not in stop_media_lxc.stderr
  changed_when: stop_media_lxc.rc == 0

- name: Wait for LXC to stop
  ansible.builtin.pause:
    seconds: 5

- name: Enable privileged mode for media stack LXC
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
    regexp: "^unprivileged:"
    line: "unprivileged: 0"
    state: present
  delegate_to: "{{ proxmox_host }}"

- name: Enable nesting feature
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
    regexp: "^features:"
    line: "features: nesting=1,fuse=1"
    state: present
  delegate_to: "{{ proxmox_host }}"

# GPU Passthrough Configuration
- name: Check if GPU passthrough is enabled
  ansible.builtin.set_fact:
    gpu_passthrough_enabled: "{{ gpu_passthrough | default(false) }}"

- name: Configure GPU passthrough
  when: gpu_passthrough_enabled
  block:
    - name: Get GPU render device
      ansible.builtin.shell: |
        set -o pipefail
        ls -la /dev/dri/renderD* 2>/dev/null | head -1 | awk '{print $NF}'
      register: gpu_render_device
      delegate_to: "{{ proxmox_host }}"
      changed_when: false

    - name: Get GPU card device
      ansible.builtin.shell: |
        set -o pipefail
        ls -la /dev/dri/card* 2>/dev/null | head -1 | awk '{print $NF}'
      register: gpu_card_device
      delegate_to: "{{ proxmox_host }}"
      changed_when: false

    - name: Get render device major:minor
      ansible.builtin.shell: |
        set -o pipefail
        stat -c '0x%t 0x%T' {{ gpu_render_device.stdout }} | xargs printf '%d:%d\n'
      register: render_majmin
      delegate_to: "{{ proxmox_host }}"
      when: gpu_render_device.stdout != ""
      changed_when: false

    - name: Get card device major:minor
      ansible.builtin.shell: |
        set -o pipefail
        stat -c '0x%t 0x%T' {{ gpu_card_device.stdout }} | xargs printf '%d:%d\n'
      register: card_majmin
      delegate_to: "{{ proxmox_host }}"
      when: gpu_card_device.stdout != ""
      changed_when: false

    - name: Add GPU device passthrough (render)
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
        line: "lxc.cgroup2.devices.allow: c {{ render_majmin.stdout }} rwm"
        state: present
      delegate_to: "{{ proxmox_host }}"
      when: render_majmin.stdout is defined

    - name: Add GPU device passthrough (card)
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
        line: "lxc.cgroup2.devices.allow: c {{ card_majmin.stdout }} rwm"
        state: present
      delegate_to: "{{ proxmox_host }}"
      when: card_majmin.stdout is defined

    - name: Mount GPU render device in LXC
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
        line: "lxc.mount.entry: {{ gpu_render_device.stdout }} dev/dri/renderD128 none bind,optional,create=file 0 0"
        state: present
      delegate_to: "{{ proxmox_host }}"
      when: gpu_render_device.stdout != ""

    - name: Mount GPU card device in LXC
      ansible.builtin.lineinfile:
        path: "/etc/pve/lxc/{{ media_lxc_id }}.conf"
        line: "lxc.mount.entry: {{ gpu_card_device.stdout }} dev/dri/card0 none bind,optional,create=file 0 0"
        state: present
      delegate_to: "{{ proxmox_host }}"
      when: gpu_card_device.stdout != ""

    - name: Display GPU passthrough info
      ansible.builtin.debug:
        msg: |
          GPU passthrough configured:
          - Render: {{ gpu_render_device.stdout | default('not found') }}
          - Card: {{ gpu_card_device.stdout | default('not found') }}

  rescue:
    - name: GPU passthrough failed
      ansible.builtin.debug:
        msg: "GPU passthrough configuration failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Fail with error details
      ansible.builtin.fail:
        msg: "GPU passthrough configuration failed. Check GPU device availability on Proxmox host."

- name: Start media stack LXC
  ansible.builtin.command:
    cmd: "pct start {{ media_lxc_id }}"
  delegate_to: "{{ proxmox_host }}"
  register: start_media_lxc
  failed_when: start_media_lxc.rc != 0 and "is already running" not in start_media_lxc.stderr
  changed_when: start_media_lxc.rc == 0

- name: Wait for LXC to start
  ansible.builtin.pause:
    seconds: 10

- name: Wait for LXC to be reachable
  ansible.builtin.wait_for_connection:
    timeout: 120
