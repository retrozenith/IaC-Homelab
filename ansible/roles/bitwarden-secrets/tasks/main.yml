---
# Fetches secrets from Bitwarden Secrets Manager using the CLI
# Requires: bws CLI installed and BWS_ACCESS_TOKEN environment variable set
# This role runs on localhost (no sudo needed)

- name: Check if BWS_ACCESS_TOKEN is set
  ansible.builtin.fail:
    msg: "BWS_ACCESS_TOKEN environment variable must be set"
  when: lookup('env', 'BWS_ACCESS_TOKEN') == ''

- name: Define secret mappings
  ansible.builtin.set_fact:
    bitwarden_secrets:
      - bw_var: bw_secret_smb_password
        fact_name: smb_media_password
        skip_placeholder: false
      - bw_var: bw_secret_smb_admin_password
        fact_name: smb_admin_password
        skip_placeholder: true
      - bw_var: bw_secret_wireguard_key
        fact_name: wireguard_private_key
        skip_placeholder: false
      - bw_var: bw_secret_streamystats_db
        fact_name: streamystats_db_password
        skip_placeholder: false
      - bw_var: bw_secret_streamystats_session
        fact_name: streamystats_session_secret
        skip_placeholder: false
      - bw_var: bw_secret_cloudflare_token
        fact_name: cloudflare_api_token
        skip_placeholder: true
      - bw_var: bw_secret_domain_name
        fact_name: domain_name
        skip_placeholder: true
      - bw_var: bw_secret_le_email
        fact_name: le_email
        skip_placeholder: true
      - bw_var: bw_secret_github_pat
        fact_name: monitoring_github_pat
        skip_placeholder: true
      - bw_var: bw_secret_traefik_auth
        fact_name: traefik_dashboard_auth
        skip_placeholder: false
      - bw_var: bw_secret_grafana_password
        fact_name: monitoring_grafana_admin_password
        skip_placeholder: false

- name: Fetch secrets from Bitwarden
  ansible.builtin.command:
    cmd: "bws secret get {{ lookup('vars', item.bw_var) }} --output json"
  environment:
    BWS_ACCESS_TOKEN: "{{ lookup('env', 'BWS_ACCESS_TOKEN') }}"
  register: bw_results
  changed_when: false
  no_log: true
  become: false
  loop: "{{ bitwarden_secrets }}"
  when:
    - lookup('vars', item.bw_var, default='') is defined
    - lookup('vars', item.bw_var, default='') != ''
    - not (item.skip_placeholder and 'PLACEHOLDER' in lookup('vars', item.bw_var, default=''))

- name: Set secret facts
  ansible.builtin.set_fact:
    "{{ item.item.fact_name }}": "{{ (item.stdout | from_json).value }}"
  no_log: true
  loop: "{{ bw_results.results }}"
  when:
    - item.stdout is defined
    - not item.skipped | default(false)
  loop_control:
    label: "{{ item.item.fact_name }}"

- name: Fetch Vaultwarden Token from Bitwarden (special case)
  ansible.builtin.command:
    cmd: "bws secret get {{ bw_secret_vaultwarden_token }} --output json"
  environment:
    BWS_ACCESS_TOKEN: "{{ lookup('env', 'BWS_ACCESS_TOKEN') }}"
  register: bw_token_result
  changed_when: false
  no_log: true
  become: false
  when:
    - bw_secret_vaultwarden_token is defined
    - bw_secret_vaultwarden_token != ''
    - "'PLACEHOLDER' not in bw_secret_vaultwarden_token"

- name: Generate Argon2 hash for Vaultwarden Token
  ansible.builtin.shell: |
    set -o pipefail
    SALT=$(openssl rand -base64 16)
    echo -n "{{ (bw_token_result.stdout | from_json).value }}" | argon2 "$SALT" -e -id -t 2 -k 65536 -p 4
  register: vaultwarden_hash_result
  changed_when: false
  no_log: true
  become: false
  args:
    executable: /bin/bash
  when:
    - bw_token_result is defined
    - bw_token_result.stdout is defined

- name: Set Vaultwarden Token Hash fact
  ansible.builtin.set_fact:
    vaultwarden_admin_token: "{{ vaultwarden_hash_result.stdout }}"
  no_log: true
  when:
    - vaultwarden_hash_result is defined
    - vaultwarden_hash_result.stdout is defined
