---
- name: Deploy Traefik Reverse Proxy
  hosts: proxies
  become: true
  gather_facts: false

  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Fetch secrets from Bitwarden
      ansible.builtin.include_tasks: tasks/fetch_secrets.yml

    - name: Configure LXC for Docker support (on Proxmox host)
      ansible.builtin.include_role:
        name: proxmox_lxc_configure
      vars:
        lxc_id: "{{ traefik_lxc_id }}"
      tags: [lxc-config]

    - name: Wait for system to be reachable
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Gather facts after connection
      ansible.builtin.setup:

  roles:
    - role: common
      tags: [common, setup]

    - role: ufw
      tags: [firewall, setup]
      vars:
        ufw_allow_ports:
          - 80
          - 443
          - 8080
          - 9100
          - 8082

    - role: docker
      tags: [docker, setup]

    - role: node-exporter
      tags: [node-exporter, monitoring]

    - role: traefik
      tags: [traefik, deploy]

  post_tasks:
    - name: Display access information
      ansible.builtin.debug:
        msg: Traefik Proxy deployed successfully!
