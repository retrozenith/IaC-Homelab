---
name: Self-Heal Infrastructure

on:
  schedule:
    - cron: "*/15 * * * *" # Every 15 minutes
  repository_dispatch:
    types: [health-alert] # Alertmanager webhook
  workflow_dispatch:
    inputs:
      target:
        description: "Target to heal (host group)"
        type: choice
        options:
          - all
          - docker_services
          - proxies
          - monitoring
          - storage
        default: all
      playbook:
        description: "Playbook to run"
        type: choice
        options:
          - self-heal
          - site
        default: self-heal
      dry_run:
        description: "Dry run (check mode)"
        type: boolean
        default: false

env:
  ANSIBLE_HOST_KEY_CHECKING: "false"
  ANSIBLE_FORCE_COLOR: "true"

jobs:
  self-heal:
    name: Self-Heal Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:server

      - name: Wait for Tailscale routes
        run: |
          echo "Waiting for subnet routes to be available..."
          sleep 10
          tailscale status
          echo "Testing connectivity to docker-services..."
          ping -c 3 192.168.0.100 || echo "Ping failed, but SSH may still work"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/andromeda_deploy
          chmod 600 ~/.ssh/andromeda_deploy
          ssh-keyscan -H 192.168.0.100 >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H 192.168.0.101 >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H 192.168.0.102 >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H 192.168.0.254 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Determine target and playbook
        id: config
        run: |
          # Set target based on trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET="${{ github.event.inputs.target }}"
            PLAYBOOK="${{ github.event.inputs.playbook }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            # Extract from alert payload
            TARGET="${{ github.event.client_payload.target || 'all' }}"
            PLAYBOOK="self-heal"
            DRY_RUN="false"
          else
            # Scheduled run
            TARGET="all"
            PLAYBOOK="self-heal"
            DRY_RUN="false"
          fi

          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "playbook=$PLAYBOOK" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

          echo "üéØ Target: $TARGET"
          echo "üìã Playbook: $PLAYBOOK"
          echo "üîç Dry Run: $DRY_RUN"

      - name: Run self-heal playbook
        working-directory: ansible
        run: |
          LIMIT=""
          if [ "${{ steps.config.outputs.target }}" != "all" ]; then
            LIMIT="--limit ${{ steps.config.outputs.target }}"
          fi

          CHECK=""
          if [ "${{ steps.config.outputs.dry_run }}" == "true" ]; then
            CHECK="--check"
          fi

          ansible-playbook \
            -i inventory/hosts.yml \
            playbooks/${{ steps.config.outputs.playbook }}.yml \
            $LIMIT \
            $CHECK \
            -v

      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Self-healing completed successfully"
          else
            echo "‚ùå Self-healing failed"
          fi
